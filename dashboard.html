<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consumer Behavior Tracker - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4B4BC1',
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="http://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet-extra-markers@1.0.1/dist/js/leaflet.extra-markers.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    
    <style>
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .map-container {
            position: relative;
            height: 400px;
            width: 100%;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #tooltip {
            position: absolute;
            background-color: #333;
            color: white;
            padding: 5px;
            border-radius: 4px;
            pointer-events: none;
            display: none;
            z-index: 1000;
        }
        .leaflet-heatmap-layer {
          opacity: 0.8;
        }
        .map-legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 14px;
        }
        .map-legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 font-sans leading-normal tracking-normal text-gray-800 dark:text-gray-200">

    <div id="dashboard" class="container mx-auto p-4">
        <header class="flex flex-col sm:flex-row justify-between items-center py-4 mb-8 border-b-2 border-gray-200 dark:border-gray-700">
            <h1 class="text-3xl font-extrabold text-primary mb-4 sm:mb-0">Consumer Dashboard</h1>
            <div class="flex items-center space-x-4">
                <button id="addActivityBtn" class="bg-primary text-white py-2 px-4 rounded-lg shadow hover:bg-primary-dark transition duration-300 text-sm">Add Activity Data</button> 
				<button id="refreshBtn" class="bg-blue-500 text-white py-2 px-4 rounded-lg shadow hover:bg-blue-600 transition duration-300 text-sm">
                    <i class="fas fa-sync-alt mr-1"></i> Refresh Dashboard
                </button>
                <button id="logoutBtn" class="bg-red-500 text-white py-2 px-4 rounded-lg shadow hover:bg-red-600 transition duration-300 text-sm">Logout</button>
            </div>
        </header>

        <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Consumers</p>
                        <p id="totalConsumers" class="text-3xl font-bold mt-1 text-gray-900 dark:text-gray-100">0</p>
                    </div>
                    <i class="fas fa-users text-primary text-3xl opacity-75"></i>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Active Locations</p>
                        <p id="activeLocations" class="text-3xl font-bold mt-1 text-gray-900 dark:text-gray-100">0</p>
                    </div>
                    <i class="fas fa-map-marker-alt text-primary text-3xl opacity-75"></i>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Conversion Rate</p>
                        <p id="conversionRate" class="text-3xl font-bold mt-1 text-gray-900 dark:text-gray-100">7.2%</p>
                    </div>
                    <i class="fas fa-chart-line text-primary text-3xl opacity-75"></i>
                </div>
            </div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-bold mb-4">Hourly Activity</h2>
                <div class="chart-container">
                    <canvas id="hourlyActivityChart"></canvas>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-bold mb-4">Demographics</h2>
                <div class="chart-container">
                    <canvas id="demographicsChart"></canvas>
                </div>
            </div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-bold mb-4">Recommendations</h2>
                <div class="space-y-4">
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <h3 class="font-semibold text-lg text-primary">Optimize Peak Hours</h3>
                        <p class="text-sm mt-1">Focus on staffing and promotions between <span id="peakHours" class="font-bold"></span> to capitalize on high traffic.</p>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <h3 class="font-semibold text-lg text-primary">Target Key Demographics</h3>
						<div id="targetDemographicsOutput" class="p-4 bg-white rounded-lg shadow-md">
                        <p class="text-sm text-gray-500">Loading analysis...</p>
                    </div>
                </div>
            </div>

            <div class="bg-cream dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-bold mb-4">Overview Map</h2>
                <div class="flex justify-end mb-2 space-x-2">
                    <button id="toggleMapViewBtn" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 py-1 px-3 rounded-md shadow hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-300 text-xs">Switch to Clusters</button>
                </div>
                <div id="map" class="map-container">
                    <div id="mapLegend" class="map-legend dark:bg-gray-800 dark:text-white">
                        <h4 class="font-bold mb-2">Item Categories</h4>
                    </div>
                </div>
            </div>
		</section>
			 <section class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-bold mb-4">Data Management</h2>
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">              
                <button id="exportCsvBtn" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 py-2 px-4 rounded-lg shadow hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-300 text-sm">Export to CSV</button>
            </div>
        </section>
    </div>

    <div id="addActivityModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 hidden">
        <div class="relative p-8 bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg">
            <button class="absolute top-4 right-4 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" onclick="closeActivityModal()">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="text-2xl font-bold mb-4">Add Consumer Activity Data</h3>
			<h4 class="text-lg font-semibold mt-4 mb-2">Individual Consumer Interactions</h4>
                <div id="interaction-inputs" class="space-y-3 p-3 border border-dashed rounded-md dark:border-gray-600">
                </div>
                <button type="button" id="addInteractionField" class="text-primary text-sm font-semibold hover:text-primary-dark mt-2">
                <i class="fas fa-plus-circle mr-1"></i> Add Interaction (Browse/Purchase/Return)
                </button>
            <p id="geolocationStatus" class="text-sm mb-4 text-center"></p>
            <form id="activityForm" class="space-y-4">
                <div>
                    <label for="activityTime" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Time of Day</label>
                    <select id="activityTime" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-dark focus:ring focus:ring-primary-dark focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600">
					 <option value="">Select Time of Day</option>
                       <option value="08:00">08:00</option>
                       <option value="09:00">09:00</option> 
					   <option value="10:00">10:00</option>
                       <option value="11:00">11:00</option>
					   <option value="12:00">12:00</option>
                       <option value="13:00">13:00</option> 
					   <option value="14:00">14:00</option>
                       <option value="15:00">15:00</option>
					   <option value="16:00">16:00</option>
					   <option value="17:00">17:00</option>
                       <option value="18:00">18:00</option> 
					   <option value="19:00">19:00</option>
                       <option value="20:00">20:00</option>
                    </select>
                </div>
                <div>
                    <label for="activityLat" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Location Latitude</label>
                    <input type="number" step="any" id="activityLat" name="activityLat" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-dark focus:ring focus:ring-primary-dark focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div>
                    <label for="activityLon" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Location Longitude</label>
                    <input type="number" step="any" id="activityLon" name="activityLon" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-dark focus:ring focus:ring-primary-dark focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600">
                </div>				              
                <div>
                    <label for="activityCount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Consumer Count</label>
                    <input type="number" id="activityCount" name="activityCount" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-dark focus:ring focus:ring-primary-dark focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div>
                    <label for="activityAge" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Age Group</label>
                    <input type="text" id="activityAge" name="activityAge" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-dark focus:ring focus:ring-primary-dark focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600">
                </div>                              
                <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-dark">Add Data</button>
            </form>
        </div>
    </div>
	
    <script>
        // CRITICAL: The first check for a token to ensure the user is logged in
        const initialToken = localStorage.getItem('token');
        if (!initialToken) {
            // If no token, redirect to the login page and stop script execution
            window.location.href = 'index.html'; 
        }
		const API_BASE_URL = 'https://cbt-marlo.onrender.com';
		
        // Store charts, map, and heatmap layers instance globally for updates
        let hourlyActivityChart, demographicsChart, map;
        let heatLayers = {};
        let clusterLayers = {};
        let currentMapMode = 'heatmap'; // 'heatmap' or 'cluster'
        const categoryColors = ['#5D5CDE', '#34D399', '#FBBF24', '#F87171', '#60A5FA', '#8B5CF6'];

        // ---- API UTILITIES ----
        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('token');
            const headers = {
                ...options.headers,
                'Content-Type': 'application/json'
            };

            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch(url, { ...options, headers });
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('token');
                localStorage.removeItem('userId');
                // CRITICAL: Redirect to login on failed auth check
                window.location.href = 'index.html'; 
                throw new Error('Unauthorized');
            }
            return response;
        }

        // ---- MODAL AND UI FUNCTIONS ----
        function showActivityModal() {
            document.getElementById('addActivityModal').classList.remove('hidden');
			document.getElementById('interaction-inputs').innerHTML = ''; // Clear previous fields
            addInteractionField(); // Add the first interaction field
            getGeolocation();
         // Attempt to get current geolocation when the modal is shown
            getGeolocation();
        }
        function closeActivityModal() { document.getElementById('addActivityModal').classList.add('hidden'); }

        function addInteractionField() {
            const inputsContainer = document.getElementById('interaction-inputs');
            const newField = document.createElement('div');
            newField.className = 'p-3 bg-gray-50 dark:bg-gray-700 rounded-md border border-gray-200 dark:border-gray-600';
            newField.innerHTML = `
                <div class="flex justify-end">
                    <button type="button" class="text-red-500 hover:text-red-700 remove-interaction-field"><i class="fas fa-times-circle"></i></button>
                </div>
                <div class="space-y-2">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">Behavior Type</label>
                        <select name="interactionBehaviour" required class="w-full p-2 text-sm border border-gray-300 rounded-md dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                            <option value="Purchasing">Purchasing</option>
                            <option value="Browsing">Browsing</option>
                            <option value="Returning">Returning</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">Item Name</label>
                        <input type="text" name="interactionItem" placeholder="e.g., Tacos, Laptop, T-shirt" required class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm dark:bg-gray-800 dark:border-gray-600">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">Item Category</label>
                        <select name="interactionCategory" required class="w-full p-2 text-sm border border-gray-300 rounded-md dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                            <option value="Electronics">Electronics</option>
                            <option value="Apparel">Apparel</option>
                            <option value="Groceries">Groceries</option>
                            <option value="Home Goods">Home Goods</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
            `;
            inputsContainer.appendChild(newField);
            newField.querySelector('.remove-interaction-field').addEventListener('click', () => newField.remove());
        }
        // Custom message box to replace alert()
        function showMessage(message, isError = false) {
            const messageBox = document.createElement('div');
            messageBox.innerHTML = `
                <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
                    <div class="relative p-8 bg-white dark:bg-gray-800 rounded-lg shadow-xl w-80 text-center">
                        <h3 class="text-xl font-bold mb-4">${isError ? 'Error' : 'Info'}</h3>
                        <p>${message}</p>
                        <button onclick="this.parentElement.parentElement.remove()" class="mt-4 py-2 px-4 rounded-md bg-primary text-white hover:bg-primary-dark">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(messageBox);
        }

        // ---- GEOLOCATION FUNCTIONS ----
        function getGeolocation() {
            const statusMessage = document.getElementById('geolocationStatus');
            statusMessage.textContent = 'Attempting to find your location...';
            statusMessage.className = 'text-sm mb-4 text-center text-gray-500 dark:text-gray-400';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        document.getElementById('activityLat').value = position.coords.latitude;
                        document.getElementById('activityLon').value = position.coords.longitude;
                        statusMessage.textContent = 'Location found successfully! You can edit the values if needed.';
                        statusMessage.className = 'text-sm mb-4 text-center text-green-500 dark:text-green-400';
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        statusMessage.textContent = 'Could not find your location. Please enter coordinates manually.';
                        statusMessage.className = 'text-sm mb-4 text-center text-red-500 dark:text-red-400';
                    }
                );
            } else {
                statusMessage.textContent = 'Geolocation is not supported by your browser.';
                statusMessage.className = 'text-sm mb-4 text-center text-red-500 dark:text-red-400';
            }
        }

        // ---- CHART FUNCTIONS ----
        function initCharts() {
            const hourlyCtx = document.getElementById('hourlyActivityChart').getContext('2d');
            hourlyActivityChart = new Chart(hourlyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Consumers',
                        data: [],
                        borderColor: '#5D5CDE',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });

            const demoCtx = document.getElementById('demographicsChart').getContext('2d');
            demographicsChart = new Chart(demoCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Demographics',
                        data: [],
                        backgroundColor: [
                            '#5D5CDE', '#34D399', '#FBBF24', '#F87171', '#60A5FA', '#8B5CF6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function updateHourlyChart(data) {
            const hourlyCounts = data.reduce((acc, curr) => {
                const hour = new Date(`2000/01/01 ${curr.time}`).getHours();
                const label = `${hour}:00`;
                acc[label] = (acc[label] || 0) + curr.count;
                return acc;
            }, {});
            const labels = Object.keys(hourlyCounts).sort();
            const counts = labels.map(label => hourlyCounts[label]);
            hourlyActivityChart.data.labels = labels;
            hourlyActivityChart.data.datasets[0].data = counts;
            hourlyActivityChart.update();
        }        

        function updateDemographicsChart(data) {
            // CRITICAL FIX: Map to the new dynamic field names (age_group and count)
            const labels = data.map(d => d.age_group);
            const counts = data.map(d => d.count);
    
            // Sort data for consistent chart display (optional but recommended)
            // Note: Pie charts use raw counts, and Chart.js calculates the percentages automatically.
    
            demographicsChart.data.labels = labels;
            demographicsChart.data.datasets[0].data = counts; 
            demographicsChart.update();
        }

        // ---- MAP FUNCTIONS ----
        function initOverviewMap() {
            if (map) { map.remove(); }
            map = L.map('map', {center: [34.052235, -118.243683], zoom: 12});
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        function clearMapLayers() {
            // 1. Remove all stored heat layers from the map
            for (const key in heatLayers) {
                if (map.hasLayer(heatLayers[key])) {
                    map.removeLayer(heatLayers[key]);
                }
            }
            // 2. Remove all stored cluster layers from the map
            for (const key in clusterLayers) {
                if (map.hasLayer(clusterLayers[key])) {
                    map.removeLayer(clusterLayers[key]);
                }
            }
            // 3. Clear the objects to hold the new layers
            heatLayers = {};
            clusterLayers = {};
        }
          
        function updateMap(activityData) {
           console.log("Updating map with data:", activityData);

            // CRITICAL: Clear layers AND clear the global storage objects
			//This must happen only here,at the start of a full data refresh.
            clearMapLayers(); 
            
            const legend = document.getElementById('mapLegend');
            legend.innerHTML = '<h4 class="font-bold mb-2">Item Categories</h4>';

            // Flatten the activity data (Logic remains the same, assuming it works)
            const flattenedPoints = [];
            activityData.forEach(activity => {
                if (activity.lat && activity.lon && activity.count > 0 && Array.isArray(activity.interactions)) {
                    activity.interactions.forEach(interaction => {
                        flattenedPoints.push({
                            lat: activity.lat,
                            lon: activity.lon,
                            count: activity.count, // Consumer count for this visit
                            category: interaction.category || 'Other',
                            behaviour: interaction.type || 'N/A',
                            item: interaction.item || 'N/A'
                        });
                   });
                }
            });

            if (flattenedPoints.length === 0) {
                console.log("No activity data with coordinates and interactions to display on map.");
                legend.innerHTML += `<p class="text-xs text-gray-500 dark:text-gray-400">No data available to display.</p>`;
                return;
            }
 
            // Group the *flattened* data by category for layering
            const groupedData = flattenedPoints.reduce((acc, curr) => {
                const rawCategory = curr.category || 'Other';
                const category = rawCategory.trim().toLowerCase().replace(/\s/g, '-'); 
        
                if (!acc[category]) {
                    acc[category] = { 
                        heat: [], 
                        cluster: [],
                        label: rawCategory // Store original label for legend
                    };
                }
                // Leaflet Heat expects [lat, lon, intensity]
                acc[category].heat.push([curr.lat, curr.lon, curr.count]); 
                
                // Marker Cluster expects an L.marker instance
                acc[category].cluster.push(L.marker([curr.lat, curr.lon]).bindPopup(
                    `<b>Item:</b> ${curr.item}<br><b>Category:</b> ${curr.category}<br><b>Behavior:</b> ${curr.behaviour}<br><b>Consumers:</b> ${curr.count}`
                ));
                return acc;
            }, {});

            const categories = Object.keys(groupedData).sort();
            const colors = categoryColors.slice(0, categories.length);

            // Calculate map bounds based on all points
            const allPoints = flattenedPoints.map(d => [d.lat, d.lon]);
            if (allPoints.length > 0) {
                const bounds = L.latLngBounds(allPoints);
                map.fitBounds(bounds, { padding: [50, 50] }); // Zoom map to fit all data points
            }

            categories.forEach((category, index) => {
                const categoryLabel = groupedData[category].label;
    
                // Heat Layer Creation (using unique colors)
                const color = colors[index % colors.length];
                const heatLayer = L.heatLayer(groupedData[category].heat, {
                    radius: 18,
                    blur: 12,
                    gradient: { 0.4: color, 0.6: color, 1.0: color }
                });
                // Store the layer instance globally
                heatLayers[category] = heatLayer; 

                // Cluster Layer Creation
                const clusterGroup = L.markerClusterGroup();
                clusterGroup.addLayers(groupedData[category].cluster);
                 // Store the cluster group instance globally
                clusterLayers[category] = clusterGroup; 

                // Create and add legend item (The Checklist)
                const legendItem = document.createElement('div');
                legendItem.className = 'map-legend-item';
                legendItem.innerHTML = `
                    <input type="checkbox" id="legend-${category}" data-category="${category}" checked class="mr-2">
                    <div class="w-4 h-4 rounded-full" style="background-color: ${color};"></div>
                    <label for="legend-${category}" class="text-sm cursor-pointer ml-2">${categoryLabel.toUpperCase()}</label>
                `;
                legend.appendChild(legendItem);

                // Add event listener to the checkbox
                legendItem.querySelector('input').addEventListener('change', updateMapDisplay);
            });

            // CRITICAL: Initially display layers based on the current mode and checkbox state
            updateMapDisplay();
    }
        // New function to update the map based on current state
        function updateMapDisplay() {
            const toggleButton = document.getElementById('toggleMapViewBtn');
    
            // 1. Remove ALL existing dynamic layers from the MAP (Visual removal)
            //    We manually remove them here instead of calling clearMapLayers()
            for (const category in heatLayers) {
                if (map.hasLayer(heatLayers[category])) map.removeLayer(heatLayers[category]);
            }
            for (const category in clusterLayers) {
                if (map.hasLayer(clusterLayers[category])) map.removeLayer(clusterLayers[category]);
            }

            const checkboxes = document.querySelectorAll('#mapLegend input[type="checkbox"]');

            toggleButton.textContent = currentMapMode === 'heatmap' ? 'Switch to Clusters' : 'Switch to Heatmap';

            // 2. Iterate over the checkboxes to decide which layers to ADD back to the map
            checkboxes.forEach(checkbox => {
                const category = checkbox.dataset.category;
                if (checkbox.checked) {
                    if (currentMapMode === 'heatmap' && heatLayers[category]) {
                        map.addLayer(heatLayers[category]);
                    } else if (currentMapMode === 'cluster' && clusterLayers[category]) {
                        map.addLayer(clusterLayers[category]);
                    }
                }
            });
        }
        function toggleMapView() {
            currentMapMode = currentMapMode === 'heatmap' ? 'cluster' : 'heatmap';
            updateMapDisplay();
        }

        // ---- RECOMMENDATIONS FUNCTIONS ----
        function updateRecommendations(hourlyData) {
            const hourlyCounts = hourlyData.reduce((acc, curr) => {
                const hour = new Date(`2000/01/01 ${curr.time}`).getHours();
                const label = `${hour}:00`;
                acc[label] = (acc[label] || 0) + curr.count;
                return acc;
            }, {});

            if (Object.keys(hourlyCounts).length > 0) {
                let peakHours = [];
                let maxCount = 0;

                for (const time in hourlyCounts) {
                    if (hourlyCounts[time] > maxCount) {
                        maxCount = hourlyCounts[time];
                        peakHours = [time];
                    } else if (hourlyCounts[time] === maxCount) {
                        peakHours.push(time);
                    }
                }

                document.getElementById('peakHours').textContent = peakHours.join(' & ');
            } else {
                document.getElementById('peakHours').textContent = 'N/A';
            }
        }
        // Inside copy7-auth.html, add this new function:

        function updateTargetDemographics(demographics) {
            const outputDiv = document.getElementById('targetDemographicsOutput');
            // Deconstruct the data received from the server
            const { targetAgeGroup, keyInteraction, keyCategory } = demographics;

            if (targetAgeGroup === 'N/A') {
                outputDiv.innerHTML = '<p class="text-sm text-gray-500">No activity data available to generate recommendations.</p>';
                return;
            }

            // --- Generate Recommendation Text ---
    
            let recommendation = `<p class="mb-2 text-base text-gray-800">Your **Primary Target Demographic** is the **${targetAgeGroup}** age group, as they exhibit the highest volume of activity.</p>`;
    
            recommendation += `<p class="mb-2 text-sm text-gray-700">The most common behavior observed is **${keyInteraction}** related to **${keyCategory}**.</p>`;
    
            // Add specific, realistic recommendations based on the key interaction
            if (keyInteraction === 'Browsing') {
                recommendation += `<p class="p-3 mt-4 text-sm bg-yellow-50 border border-yellow-200 rounded-md">
                    <strong>識 Recommendation:</strong> Since **Browsing** is dominant, focus on **in-store conversion tactics**. Deploy targeted point-of-sale displays or offer limited-time deals (e.g., flash sales) near the **${keyCategory}** area to convert browsing interest from the **${targetAgeGroup}** group into purchases.
                </p>`;
            } else if (keyInteraction === 'Purchasing') {
                recommendation += `<p class="p-3 mt-4 text-sm bg-green-50 border border-green-200 rounded-md">
                    <strong>識 Recommendation:</strong> High **Purchasing** volume suggests satisfaction. Focus on **maximising Average Transaction Value**. Promote complementary products (e.g., accessories or warranties) and use loyalty programs aimed at the **${targetAgeGroup}** group for **${keyCategory}** to encourage repeat business.
                </p>`;
            } else if (keyInteraction === 'Returning') {
                recommendation += `<p class="p-3 mt-4 text-sm bg-red-50 border border-red-200 rounded-md">
                    <strong>識 Recommendation:</strong> High **Returning** volume suggests an opportunity to improve service or product quality perception. Initiate a brief feedback survey at the point of return for the **${targetAgeGroup}** group, specifically on **${keyCategory}**, to mitigate negative sentiment and retain the customer.
                </p>`;
            } else {
                recommendation += `<p class="p-3 mt-4 text-sm bg-indigo-50 border border-indigo-200 rounded-md">
                    <strong>識 Recommendation:</strong> Focus on understanding and leveraging the dominant **${keyInteraction}** behavior observed in the **${targetAgeGroup}** demographic around the **${keyCategory}** items.
                </p>`;
            }

            outputDiv.innerHTML = recommendation;
        }
		function clearDashboardDisplay() {
            // 1. Reset Metrics to 0/N/A
            document.getElementById('totalConsumers').textContent = '0';
            document.getElementById('activeLocations').textContent = '0';
            document.getElementById('conversionRate').textContent = 'N/A';
    
            // 2. Robustly Clear Charts by replacing the entire data object
            if (hourlyActivityChart) {
			    // Hourly Chart Reset
                hourlyActivityChart.data = {
                    labels: [],
                    datasets: [{ 
                        label: 'Consumers', 
                        data: [], 
                        borderColor: '#5D5CDE', 
                        tension: 0.1 
                    }]				
            };
			hourlyActivityChart.update();
		}

            if (demographicsChart) {
                // Demographics Chart Reset (Ensuring correct type and colors are maintained)
                demographicsChart.data = {
                    labels: [],
                    datasets: [{ 
                        label: 'Demographics', 
                        data: [], 
                        // Must retain colors or Chart.js might throw errors
                        backgroundColor: [
                            '#5D5CDE', '#34D399', '#FBBF24', '#F87171', '#60A5FA', '#8B5CF6'
                        ]
                    }]
                };
                demographicsChart.update();
            }
			
            // 3. Clear Recommendations
            document.getElementById('peakHours').textContent = 'N/A';
            document.getElementById('targetDemographicsOutput').innerHTML = '<p class="text-sm text-gray-500">Data cleared. Refreshing...</p>';

            // 4. Clear Map layers and reset legend
            clearMapLayers(); // This existing function removes layers and clears stored data
            const legend = document.getElementById('mapLegend');
            legend.innerHTML = '<h4 class="font-bold mb-2">Item Categories</h4><p class="text-xs text-gray-500 dark:text-gray-400">Data cleared. Refreshing...</p>';
        }
        // ---- DATA AND API HANDLERS ----
        async function fetchDashboardData() {
            try {
                const response = await fetchWithAuth('https://cbt-marlo.onrender.com/api/dashboard');
                let data = await response.json();

                // Fallback data for testing if backend is not providing location data
                if (data.activity.length === 0) {
                    data.activity = [
                        { time: '09:30', lat: 34.0522, lon: -118.2437, interactions: [{ type: 'Browsing', item: 'Tacos', category: 'Food' }], count: 15, age: '25-34' },
                        { time: '12:00', lat: 34.0532, lon: -118.2450, interactions: [{ type: 'Purchasing', item: 'Shirt', category: 'Apparel' }], count: 20, age: '18-24' },
                        { time: '13:00', lat: 34.0550, lon: -118.2420, interactions: [{ type: 'Purchasing', item: 'Coffee', category: 'Groceries' }], count: 10, age: '35-44' },
                        { time: '17:45', lat: 34.0515, lon: -118.2460, interactions: [{ type: 'Browsing', item: 'Tickets', category: 'Entertainment' }], count: 5, age: '18-24' },
                        { time: '18:30', lat: 34.0528, lon: -118.2445, interactions: [{ type: 'Purchasing', item: 'Pizza', category: 'Food' }], count: 18, age: '25-34' },
                        { time: '20:00', lat: 34.0540, lon: -118.2410, interactions: [{ type: 'Browsing', item: 'Shoes', category: 'Apparel' }], count: 12, age: '45-54' },
                    ];
                }

                document.getElementById('totalConsumers').textContent = data.dashboardMetrics.totalConsumers;
                document.getElementById('activeLocations').textContent = data.dashboardMetrics.activeLocations;
                document.getElementById('conversionRate').textContent = data.dashboardMetrics.conversionRate;

                updateHourlyChart(data.activity);
                updateDemographicsChart(data.demographics);
                updateRecommendations(data.activity);
                updateMap(data.activity);
				updateTargetDemographics(data.targetKeyDemographics);
            } catch (error) {
                console.error('Failed to fetch dashboard data:', error);
            }
        }
 
        async function submitActivityData(e) {
            e.preventDefault();
            const form = document.getElementById('activityForm');
            const lat = parseFloat(document.getElementById('activityLat').value);
            const lon = parseFloat(document.getElementById('activityLon').value);
    
            const interactionRows = document.querySelectorAll('#interaction-inputs > div');
            const interactions = [];

        // Collect all dynamic interactions
        interactionRows.forEach(row => {
                const behaviour = row.querySelector('[name="interactionBehaviour"]').value;
                const item = row.querySelector('[name="interactionItem"]').value;
                const category = row.querySelector('[name="interactionCategory"]').value;

                if (behaviour && item && category) {
                    interactions.push({ type: behaviour, item, category });
                } 
            });

            if (interactions.length === 0) {
                showMessage("Please add at least one interaction (Browsing, Purchasing, or Returning).", true);
                return;
            }

            const newActivity = {
                time: document.getElementById('activityTime').value,
                lat: lat,
                lon: lon,
                count: parseInt(document.getElementById('activityCount').value), // Still useful for consumer count at the location
                age: document.getElementById('activityAge').value,           
                interactions: interactions // THE NEW ARRAY
            };
    
            try {
                const response = await fetchWithAuth('https://cbt-marlo.onrender.com/api/activity', {
                method: 'POST',
                body: JSON.stringify(newActivity)
                });
                const result = await response.json();
                console.log(result.message);
                await fetchDashboardData();
                closeActivityModal();
        
                // Reset the form and the dynamic interactions container
                form.reset(); 
                document.getElementById('interaction-inputs').innerHTML = '';
                addInteractionField(); // Add one blank field for convenience
 
                if (!isNaN(lat) && !isNaN(lon)) {
                    map.flyTo([lat, lon], 15);
                }
            } catch (error) {
                console.error('Error adding activity:', error);
                showMessage('Failed to add activity data. See console for details.', true);
            } 
        }

        // ---- INITIALIZATION AND EVENT LISTENERS ----
        document.addEventListener('DOMContentLoaded', function() {
            // Check again in case the initial check failed for some reason, 
            // though the script should have stopped.
            if (!localStorage.getItem('token')) {
                window.location.href = 'index.html';
                return;
            }

            initCharts();
            initOverviewMap();
            map.invalidateSize();
            fetchDashboardData();


            document.getElementById('logoutBtn').addEventListener('click', function() {
                localStorage.removeItem('token');
                localStorage.removeItem('userId');
                // CRITICAL: Redirect back to the login page
                window.location.href = 'index.html'; 
            });

            document.getElementById('addActivityBtn').addEventListener('click', showActivityModal);
            document.getElementById('activityForm').addEventListener('submit', submitActivityData);
			document.getElementById('refreshBtn').addEventListener('click', () => {
                clearDashboardDisplay(); // Clear the old data immediately for user feedback
                // Use setTimeout to ensure the browser has time to render the cleared state
                // before the new data fetch begins, preventing old data from "flashing."
				setTimeout(() => {
				    fetchDashboardData();
				}, 50);	
                });
            document.getElementById('toggleMapViewBtn').addEventListener('click', toggleMapView);
            document.getElementById('addInteractionField').addEventListener('click', addInteractionField);
			            
           document.getElementById('exportCsvBtn').addEventListener('click', async () => {
    try {
        const response = await fetchWithAuth('https://cbt-marlo.onrender.com/api/activity/csv');
        
        if (!response.ok) {
            throw new Error('Server responded with an error during CSV export.');
        }

        // Get the CSV text data from the response
        const csvData = await response.text();
        // Create a blob and trigger a download
        const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('href', url);
        a.setAttribute('download', 'consumer_activity_flattened.csv');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url); // Clean up
        
        showMessage("Export successful! consumer_activity_flattened.csv downloaded.", false);
    } catch (error) {
        console.error('Export failed:', error);
        showMessage("Export failed. Check server console for details or ensure the server is running.", true);
    }
        });
    </script>
</body>
</html>

